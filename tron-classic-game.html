<!doctype html>

<html>
  <head>
    <title>TRON - Dark Arcade Style</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <script src="https://unpkg.com/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

    <script>
      const ARENA_LIMIT = 39.5;
      const TRAIL_STEP = 0.5;
      const VICTORY_SCORE = 10;
      const trails = [];

      let gameStarted = false;
      let scoreP1 = 0;
      let scoreP2 = 0;

      const POWERUP_TYPES = ["SHIELD", "TURBO"];

      AFRAME.registerComponent("powerup-spawner", {
        init: function () {
          this.timer = 0;

          this.spawnInterval = 5000;

          this.activePowerUp = null;

          this.despawnTimer = null;
        },

        tick: function (time, delta) {
          if (!gameStarted) return;

          if (!this.activePowerUp) {
            this.timer += delta;

            if (this.timer >= this.spawnInterval) {
              this.spawnPowerUp();

              this.timer = 0;
            }
          } else {
            this.activePowerUp.object3D.rotation.y += 0.02;

            this.checkCollection();
          }
        },

        spawnPowerUp: function () {
          let x = Math.random() * 60 - 30;

          let z = Math.random() * 60 - 30;

          const players = document.querySelectorAll("[player-movement]");

          let validPosition = true;

          players.forEach((p) => {
            if (
              p.object3D.position.distanceTo(new THREE.Vector3(x, 0, z)) < 10
            ) {
              validPosition = false;
            }
          });

          if (!validPosition) return;

          const el = document.createElement("a-entity");

          el.setAttribute("gltf-model", "#bit");

          el.setAttribute("scale", "0.0003 0.0003 0.0003");

          el.setAttribute("position", `${x} 1 ${z}`);

          el.setAttribute("model-color", "#FF9300");

          el.setAttribute(
            "animation",
            "property: position; to: " +
              x +
              " 1.5 " +
              z +
              "; dir: alternate; loop: true; dur: 1000; easing: easeInOutSine",
          );

          document.querySelector("a-scene").appendChild(el);

          this.activePowerUp = el;

          this.despawnTimer = setTimeout(() => {
            if (this.activePowerUp) {
              this.removePowerUp();
            }
          }, 10000);
        },

        removePowerUp: function () {
          if (this.activePowerUp) {
            this.activePowerUp.remove();

            this.activePowerUp = null;
          }

          clearTimeout(this.despawnTimer);
        },

        checkCollection: function () {
          if (!this.activePowerUp) return;

          const players = document.querySelectorAll("[player-movement]");

          const pupPos = this.activePowerUp.object3D.position;

          players.forEach((p) => {
            if (p.object3D.position.distanceTo(pupPos) < 2) {
              const type =
                POWERUP_TYPES[Math.floor(Math.random() * POWERUP_TYPES.length)];

              p.components["player-movement"].collectPowerUp(type);

              this.removePowerUp();
            }
          });
        },

        reset: function () {
          this.removePowerUp();

          this.timer = 0;
        },
      });

      AFRAME.registerComponent("player-movement", {
        schema: {
          playerNum: { type: "number" },

          color: { type: "color" },

          startX: { type: "number" },

          startZ: { type: "number" },
        },

        init() {
          this.dir = new THREE.Vector3(0, 0, -1);
          this.heading = "up";
          this.baseSpeed = 18;
          this.speed = 18;
          this.lastTrailPos = new THREE.Vector3();
          this.dead = false;

          this.currentPowerUp = null;
          this.isInvulnerable = false;
          this.el.object3D.position.set(this.data.startX, 0, this.data.startZ);
          this.lastTrailPos.copy(this.el.object3D.position);
          this.boundHandleInput = this.handleInput.bind(this);
          window.addEventListener("keydown", this.boundHandleInput);
        },

        remove() {
          window.removeEventListener("keydown", this.boundHandleInput);
        },

        collectPowerUp(type) {
          if (this.currentPowerUp) return;
          this.currentPowerUp = type;

          if (type === "SHIELD") {
            this.activateShieldVisuals();
          } else if (type === "TURBO") {
            const light = this.el.querySelector("a-light");
            if (light) light.setAttribute("intensity", 5);
            setTimeout(() => {
              if (light) light.setAttribute("intensity", 2);
            }, 200);
          }
        },

        activateShieldVisuals() {
          this.shieldEntity = document.createElement("a-entity");
          this.shieldEntity.setAttribute(
            "geometry",
            "primitive: sphere; radius: 5",
          );

          this.shieldEntity.setAttribute(
            "material",
            "color: #00FFFF; opacity: 0.4; transparent: true; side: double; emissive: #00FFFF; emissiveIntensity: 0.6",
          );

          this.shieldEntity.setAttribute(
            "animation",
            "property: material.opacity; from: 0.4; to: 0.1; dir: alternate; loop: true; dur: 800",
          );

          this.el.appendChild(this.shieldEntity);
        },

        useTurbo() {
          if (this.currentPowerUp !== "TURBO") return;
          this.speed = this.baseSpeed * 3;
          this.currentPowerUp = null;

          const light = this.el.querySelector("a-light");

          if (light) {
            light.setAttribute("color", "#FF00FF");
            light.setAttribute("intensity", 6);
            light.setAttribute("distance", 25);
          }

          setTimeout(() => {
            this.speed = this.baseSpeed;

            if (light) {
              light.setAttribute(
                "color",
                this.data.playerNum === 1 ? "#d6f1f3" : "#ff6600",
              );

              light.setAttribute("intensity", 2);
              light.setAttribute("distance", 15);
            }
          }, 2000);
        },

        handleInput(e) {
          if (this.dead) return;

          const p1 = this.data.playerNum === 1;


          const controls = p1
            ? { u: "w", d: "s", l: "a", r: "d", activate: "q" }
            : {
                u: "ArrowUp",
                d: "ArrowDown",
                l: "ArrowLeft",
                r: "ArrowRight",
                activate: "Control",
              };

          if (e.key === controls.u && this.heading !== "down")
            this.setDir(0, 0, -1, "up", 0);
          else if (e.key === controls.d && this.heading !== "up")
            this.setDir(0, 0, 1, "down", Math.PI);
          else if (e.key === controls.l && this.heading !== "right")
            this.setDir(-1, 0, 0, "left", Math.PI / 2);
          else if (e.key === controls.r && this.heading !== "left")
            this.setDir(1, 0, 0, "right", -Math.PI / 2);

          if (e.key === controls.activate) {
            this.useTurbo();
          }
        },

        setDir(x, y, z, h, rot) {
          this.dir.set(x, y, z);

          this.heading = h;

          this.el.object3D.rotation.y = rot;
        },

        tick(time, delta) {
          if (!gameStarted || this.dead) return;

          const step = (this.speed * delta) / 1000;
          const pos = this.el.object3D.position;
          pos.addScaledVector(this.dir, step);

          if (Math.abs(pos.x) > ARENA_LIMIT || Math.abs(pos.z) > ARENA_LIMIT) {
            this.die();

            return;
          }

          if (pos.distanceTo(this.lastTrailPos) >= TRAIL_STEP) {
            this.createTrailSegment(pos);
            this.lastTrailPos.copy(pos);
          }

          this.checkCollisions(pos);
        },

        createTrailSegment(pos) {
          if (this.isInvulnerable) return;

          const seg = document.createElement("a-box");
          seg.setAttribute("width", 0.6);
          seg.setAttribute("height", 1.2);
          seg.setAttribute("depth", 0.6);
          seg.setAttribute("color", this.data.color);
          seg.setAttribute("class", "wall");
          seg.setAttribute(
            "material",
            `shader: standard; opacity: 0.6; transparent: true; emissive:${this.data.color}; emissiveIntensity: 2`,
          );

          seg.object3D.position.set(pos.x, 0.6, pos.z);
          document.querySelector("a-scene").appendChild(seg);
          trails.push({ x: pos.x, z: pos.z, owner: this.data.playerNum });
        },

        checkCollisions(pos) {
          if (this.isInvulnerable) return;

          const len = trails.length;

          for (let i = 0; i < len; i++) {
            const t = trails[i];
            const dx = pos.x - t.x;
            const dz = pos.z - t.z;

            if (dx * dx + dz * dz < 0.5) {
              if (t.owner === this.data.playerNum && i >= len - 12) continue;
              if (this.currentPowerUp === "SHIELD") {
                this.currentPowerUp = null;

                if (this.shieldEntity) {
                  this.shieldEntity.remove();
                  this.shieldEntity = null;
                }

                const pop = document.createElement("a-entity");
                pop.setAttribute("geometry", "primitive: sphere; radius: 5");
                pop.setAttribute(
                  "material",
                  "color: #FFF; transparent: true; opacity: 0.8; shader: flat",
                );
                pop.setAttribute(
                  "animation",
                  "property: scale; to: 5 5 5; dur: 200",
                );
                pop.setAttribute(
                  "animation__fade",
                  "property: material.opacity; to: 0; dur: 200",
                );
                pop.object3D.position.copy(this.el.object3D.position);
                document.querySelector("a-scene").appendChild(pop);
                setTimeout(() => pop.remove(), 250);
                this.isInvulnerable = true;
                this.el.setAttribute(
                  "material",
                  "opacity: 0.5; transparent: true",
                );

                setTimeout(() => {
                  this.isInvulnerable = false;
                  this.el.setAttribute("material", "opacity: 1");
                }, 400);

                return;
              }

              this.die();

              return;
            }
          }
        },

        die() {
          if (this.dead) return;

          this.dead = true;

          if (this.shieldEntity) {
            this.shieldEntity.remove();
            this.shieldEntity = null;
          }

          const boom = document.createElement("a-entity");

          boom.setAttribute("geometry", "primitive: sphere; radius: 0.5");

          boom.setAttribute(
            "material",
            "color: red; emissive: red; emissiveIntensity: 5; opacity: 1; transparent: true",
          );

          boom.setAttribute(
            "animation",
            "property: scale; to: 10 10 10; dur: 300",
          );

          boom.setAttribute(
            "animation__fade",
            "property: material.opacity; to: 0; dur: 300",
          );

          boom.object3D.position.copy(this.el.object3D.position);

          document.querySelector("a-scene").appendChild(boom);

          if (scoreP1 >= VICTORY_SCORE - 1) {
            this.win();
          }
          else if (this.data.playerNum === 1) {
            scoreP2++;

            document
              .querySelector("#text-p2")
              .setAttribute("text", "value", `P2: ${scoreP2}`);
            let scoreE2 = document.querySelector(
              this.data.playerNum === 1 ? "#text-p2" : "#text-p1",
            );
            scoreE2.setAttribute(
              "animation",
              "property: scale; from: 1.5 1.5 1.5; to: 1 1 1; dur: 500",
            );
            setTimeout(() => {
              scoreE2.removeAttribute("animation");
            }, 510);
            setTimeout(() => {
              if (typeof resetGame === "function") resetGame();
            }, 2000);
          } else {
            scoreP1++;

            document
              .querySelector("#text-p1")
              .setAttribute("text", "value", `P1: ${scoreP1}`);
            let scoreEl = document.querySelector(
              this.data.playerNum === 2 ? "#text-p1" : "#text-p2",
            );
            scoreEl.setAttribute(
              "animation",
              "property: scale; from: 1.5 1.5 1.5; to: 1 1 1; dur: 500",
            );
            setTimeout(() => {
              scoreE1.removeAttribute('animation');
            }, 510);            
            setTimeout(() => {
              if (typeof resetGame === "function") resetGame();
            }, 2000);
          }

          setTimeout(() => boom.remove(), 350);
        },
        
        win(){
          gameStarted = false;
          const winner = this.data.playerNum === VICTORY_SCORE ? 'P2' : 'P1';
          const message = document.createElement('a-entity');
          if (winner === "P1") {
            message.setAttribute('text', `value: ${winner} WINS!; align: center; width: 60; color: #7DFDFE; font: monoid`);
          }
          else {
            message.setAttribute('text', `value: ${winner} WINS!; align: center; width: 60; color: #ff6600; font: monoid`);
          }
          message.setAttribute('position', '0 30 0');
          message.setAttribute('animation', 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');
          document.querySelector('a-scene').appendChild(message);

          setTimeout(() => {
              message.setAttribute('animation', 'property: scale; to: 0 0 0; dur: 500; easing: easeInBack');
              scoreP1 = 0;
              scoreP2 = 0;
              document.querySelector('#text-p1').setAttribute('text', 'value', 'P1: 0');
              document.querySelector('#text-p2').setAttribute('text', 'value', 'P2: 0');
              setTimeout(() => {
                if (typeof resetGame === "function") resetGame();
              }, 5000);
            }, 5000);
        }
      });

      function resetGame() {
        gameStarted = false;

        const spawner =
          document.querySelector("[powerup-spawner]").components[
            "powerup-spawner"
          ];

        if (spawner) spawner.reset();

        trails.length = 0;

        const oldTrails = document.querySelectorAll(".wall");

        oldTrails.forEach((el) => {
          if (!el.parentElement.id.includes("arena-walls")) {
            el.remove();
          }
        });

        const players = document.querySelectorAll("[player-movement]");

        players.forEach((p) => {
          const comp = p.components["player-movement"];

          comp.dead = false;

          comp.currentPowerUp = null;

          comp.isInvulnerable = false;

          comp.speed = comp.baseSpeed;

          comp.heading = "up";

          comp.dir.set(0, 0, -1);

          comp.el.object3D.rotation.y = 0;

          comp.el.object3D.position.set(comp.data.startX, 0, comp.data.startZ);

          comp.lastTrailPos.copy(comp.el.object3D.position);

          if (comp.shieldEntity) {
            comp.shieldEntity.remove();
            comp.shieldEntity = null;
          }

          const light = p.querySelector("a-light");
          if (light) light.setAttribute("intensity", 2);
        });

        const bit = document.querySelector("#bit-entity");

        if (bit) bit.setAttribute("visible", "false");

        showMenu();
      }

      function showMenu() {
        if (document.querySelector("#start-menu")) return;

        const scene = document.querySelector("a-scene");

        const menu = document.createElement("a-entity");

        menu.setAttribute("id", "start-menu");

        menu.setAttribute("position", "0 25 20");

        menu.setAttribute("rotation", "-30 0 0");

        menu.innerHTML = `

        <a-entity gltf-model="#tron-logo" scale="9 9 9" position="0 10 0"

                  model-color="#00ffff"

                  animation="property: position; to: 0 10.5 0; dir: alternate; loop: true; dur: 2000; easing: easeInOutSine">

        </a-entity>

        <a-entity text="value: PRESIONA ENTER PARA COMENZAR; align: center; width: 60; color: #7DFDFE; font: monoid"

                  position="0 0 0">

        </a-entity>
        
        <a-light type="point" color="#00ffff" intensity="2" distance="20"></a-light>

      `;

        scene.appendChild(menu);
      }

      AFRAME.registerComponent("model-color", {
        schema: { type: "color", default: "#FFF" },

        init: function () {
          this.el.addEventListener("model-loaded", () => {
            const newColor = new THREE.Color(this.data);

            this.el.object3D.traverse((node) => {
              if (node.isMesh && node.material) {
                node.material.color.copy(newColor);

                node.material.emissive.copy(newColor);

                node.material.emissiveIntensity = 2.0;
              }
            });
          });
        },
      });

      window.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !gameStarted) {
          gameStarted = true;
          showHint();
          const menu = document.querySelector("#start-menu");

          menu.setAttribute(
            "animation",
            "property: scale; to: 0 0 0; dur: 500; easing: easeInBack",
          );

          setTimeout(() => menu.remove(), 550);

          setTimeout(() => {  
            hideHint("#controls-p1") 
            hideHint("#controls-p2")
            hideHint("#controls-p1-img")
            hideHint("#controls-p2-img")
          }, 15000);

          const bit = document.querySelector("#bit-entity");

          bit.setAttribute("visible", "true");

          bit.setAttribute("animation__spawn", {
            property: "scale",

            from: "0 0 0",

            to: "1 1 1",

            dur: 800,

            easing: "easeOutElastic",
          });
        }
      });

      window.addEventListener("keydown", (e) => {
        if (e.key.toLowerCase() === "r") {
          scoreP1 = 0;

          scoreP2 = 0;

          document
            .querySelector("#text-p1")
            .setAttribute("text", "value", "P1: 0");

          document
            .querySelector("#text-p2")
            .setAttribute("text", "value", "P2: 0");
        }
      });

      function showHint() {
        const messageHint = document.querySelector("#message-hint");
        setTimeout(() => {
          messageHint.setAttribute("visible", "true");
          messageHint.setAttribute(
            "animation__show",
            "property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack",
          );
          setTimeout(() => {
            hideHint("#message-hint");
          }, 5000);
        }, 5000);
      }

      function hideHint(params) {  
        const messageHint = document.querySelector(params);
        messageHint.setAttribute('animation__show', 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');
        messageHint.setAttribute('animation__hide', 'property: scale; to: 0 0 0; dur: 500; easing: easeInBack');
      }

      showHint();
    </script>
  </head>

  <body>
    <a-scene
      loading-screen="enabled:false"
      background="color: #050505"
      renderer="colorManagement: true; antialias: true;"
    >
      <a-assets>
        <a-asset-item
          id="modelo-moto"
          src="models/tron_moto_sdc__free.glb"
        ></a-asset-item>

        <a-asset-item
          id="modelo-moto_2"
          src="models/tron_moto_-_low_poly_-_sdc_-_free.glb"
        ></a-asset-item>

        <a-asset-item id="bit" src="models/tron_1982_bit.glb"></a-asset-item>

        <a-asset-item id="recognizer" src="models/tron.glb"></a-asset-item>

        <a-asset-item id="edificios" src="models/edificios.glb"></a-asset-item>

        <a-asset-item
          id="tron-logo"
          src="models/tron_legacy-era_neon_logo.glb"
        ></a-asset-item>

        <img id="wasd" src="/img/teclas-wasd.png" />
        <img id="arrows" src="/img/teclas-flechas.png" />
      </a-assets>

      <a-entity powerup-spawner></a-entity>

      <a-entity id="ui-score" position="0 55 10" rotation="-55 0 0">
        <a-entity
          id="text-p1"
          text="value: P1: 0; color: #00ffff; align: center; width: 30; font: monoid"
          position="-15 0 0"
        ></a-entity>

        <a-entity
          id="text-p2"
          text="value: P2: 0; color: #ff6600; align: center; width: 30; font: monoid"
          position="15 0 0"
        ></a-entity>
      </a-entity>

      <a-entity id="start-menu" position="0 25 20" rotation="-30 0 0">
        <a-entity
          gltf-model="#tron-logo"
          scale="9 9 9"
          position="0 10 0"
          animation="property: position; to: 0 10.5 0; dir: alternate; loop: true; dur: 2000; easing: easeInOutSine"
        >
        </a-entity>

        <a-entity
          text="value: PRESIONA ENTER PARA JUGAR; align: center; width: 60; color: #7DFDFE; font: monoid"
          position="0 0 0"
        >
        </a-entity>

        <a-light
          type="point"
          color="#00ffff"
          intensity="2"
          distance="20"
        ></a-light>
      </a-entity>

      <a-entity position="0 65 50" rotation="-55 0 0">
        <a-camera
          look-controls="enabled: false"
          wasd-controls="enabled: false"
        ></a-camera>
      </a-entity>

      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="200"
        height="200"
        color="#000000"
      ></a-plane>

      <a-plane
        position="0 0.1 0"
        rotation="-90 0 0"
        width="200"
        height="200"
        color="#66b4ce"
        material="wireframe: true; opacity: 0.4"
        segments-width="80"
        segments-height="80"
      ></a-plane>

      <a-entity
        position="-50 15 -50"
        animation="property: position; to: 50 15 -50; dir: alternate; loop: true; dur: 15000; easing: linear"
      >
        <a-entity
          gltf-model="#recognizer"
          scale=".2 .2 .2"
          rotation="0 -90 0"
        ></a-entity>

        <a-light
          type="point"
          color="#ff6600"
          intensity="6"
          distance="120"
          decay="2"
          position="0 -5 0"
        ></a-light>
      </a-entity>

      <a-entity id="arena-walls">
        <a-box
          class="wall"
          position="-40 1 0"
          width="0.5"
          height="2"
          depth="80"
          color="#141414"
          material="emissive: #3D3D3D; emissiveIntensity: 0.5"
        ></a-box>

        <a-box
          class="wall"
          position="40 1 0"
          width="0.5"
          height="2"
          depth="80"
          color="#141414"
          material="emissive: #3D3D3D; emissiveIntensity: 0.5"
        ></a-box>

        <a-box
          class="wall"
          position="0 1 -40"
          width="80"
          height="2"
          depth="0.5"
          color="#141414"
          material="emissive: #3D3D3D; emissiveIntensity: 0.5"
        ></a-box>

        <a-box
          class="wall"
          position="0 1 40"
          width="80"
          height="2"
          depth="0.5"
          color="#141414"
          material="emissive: #3D3D3D; emissiveIntensity: 0.5"
        ></a-box>
      </a-entity>

      <a-entity
        player-movement="playerNum:1; color:#00ffff; startX:-10; startZ:30"
      >
        <a-entity
          gltf-model="#modelo-moto"
          scale="0.005 0.005 0.005"
          rotation="0 180 0"
        ></a-entity>

        <a-light
          type="point"
          color="#d6f1f3"
          intensity="2"
          distance="15"
          decay="1.5"
          position="0 1 0"
        ></a-light>
      </a-entity>

      <a-entity
        player-movement="playerNum:2; color:#ff6600; startX:10; startZ:30"
      >
        <a-entity
          gltf-model="#modelo-moto_2"
          scale="0.4 0.4 0.4"
          rotation="0 180 0"
        ></a-entity>

        <a-light
          type="point"
          color="#ff6600"
          intensity="2"
          distance="15"
          decay="1.5"
          position="0 1 0"
        ></a-light>
      </a-entity>

      <a-entity
        id="controls-p1"
        text="value: Usa            para 
          jugador 1; align: center; width: 80; color: #7DFDFE; font: monoid"
        position="-60 10 10"
        rotation="-60 0 0"
      >
      </a-entity>

      <a-entity id="controls-p1-img" position="-54 20 10" rotation="-60 0 0">
        <a-image src="/img/teclas-wasd.png" width="20" height="20"></a-image>
      </a-entity>

      <a-entity
        id="controls-p2"
        text="value: Usa           para 
          jugador 2; align: center; width: 80; color: #ff6600; font: monoid"
        position="60 10 10"
        rotation="-60 0 0"
      >
      </a-entity>

      <a-entity id="controls-p2-img" position="52.2 20 10" rotation="-60 0 0">
        <a-image src="/img/teclas-flechas.png" width="20" height="20"></a-image>
      </a-entity>

      <a-entity id="message-hint" scale="0 0 0">
          <a-entity text="value: Agarra los orbes y 
              presiona Q o Ctrl para usar power up; align: center; width: 80; color: #7DFDFE; font: monoid"
              position="0 40 0" rotation="-60 0 0">
          </a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
